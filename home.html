<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Uploader</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f5f5f5;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        button {
            background-color: #4caf50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        #fileList {
            margin-top: 20px;
        }

        a {
            text-decoration: none;
            color: #007BFF;
            font-weight: bold;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Responsive styles */
        @media only screen and (max-width: 600px) {
            body {
                margin: 10px;
                padding: 10px;
            }

            button {
                margin-bottom: 10px;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload File</button>
    <button onclick="deleteFile()">Delete File</button>
    <button onclick="downloadFile()">Download File</button>
    <button onclick="getFileList()">Refresh</button>
    <div id="fileList"></div>

    <script>
        function getUserInput() {
            const accessToken = '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';
            const username = '2003040';
            const repoName = localStorage.getItem('signinusername');

            return { accessToken, username, repoName };
        }

        async function uploadFile() {
            const { accessToken, username, repoName } = getUserInput();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            const branch = 'main'; // or 'master'

            const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${file.name}`;

            const fileReader = new FileReader();

            fileReader.onload = async function (event) {
                const content = event.target.result.split(',')[1]; // Extract base64-encoded content

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Upload file',
                        content: content,
                        branch: branch,
                    }),
                });

                if (response.ok) {
                    alert('File uploaded successfully!');
                    getFileList();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.message}`);
                }
            };

            fileReader.readAsDataURL(file);
        }

        async function getFileList() {
            const { username, repoName } = getUserInput();
            const branch = 'main'; // or 'master'

            const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents?ref=${branch}`;

            const response = await fetch(apiUrl);
            const data = await response.json();

            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3>Uploaded Files:</h3>';

            data.forEach(file => {
                if (file.type === 'file') {
                    const fileLink = document.createElement('a');
                    fileLink.href = file.html_url;
                    fileLink.textContent = file.name;
                    fileLink.target = '_blank';
                    fileList.appendChild(fileLink);
                    fileList.appendChild(document.createElement('br'));
                }
            });
        }

        async function deleteFile() {
            const { accessToken, username, repoName } = getUserInput();

            const fileToDelete = prompt('Enter the name of the file to delete:');

            if (!fileToDelete) {
                alert('Please enter the name of the file to delete.');
                return;
            }

            const branch = 'main'; // or 'master'

            // Get the commit SHA for the file
            const getFileUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${fileToDelete}?ref=${branch}`;
            const getFileResponse = await fetch(getFileUrl);
            const fileData = await getFileResponse.json();

            if (!fileData.sha) {
                alert(`Error: Could not get the SHA for the file '${fileToDelete}'.`);
                return;
            }

            const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${fileToDelete}`;

            const response = await fetch(apiUrl, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Delete file',
                    branch: branch,
                    sha: fileData.sha, // Include the commit SHA
                }),
            });

            if (response.ok) {
                alert('File deleted successfully!');
                getFileList();
            } else {
                const data = await response.json();
                alert(`Error: ${data.message}`);
            }
        }

        function downloadFile() {
            const { username, repoName } = getUserInput();

            const fileToDownload = prompt('Enter the name of the file to download:');

            if (!fileToDownload) {
                alert('Please enter the name of the file to download.');
                return;
            }

            const downloadUrl = `https://raw.githubusercontent.com/${username}/${repoName}/main/${fileToDownload}`;

            window.open(downloadUrl, '_blank');
        }

        async function refreshFileList() {
            getFileList();
        }

        // Initial file list retrieval
        getFileList();
    </script>
</body>

</html>
